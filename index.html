<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Avançada de Cálculo DDR/DRB e Análise de Extrusão</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --primary: #00ccff;
            --secondary: #6c5ce7;
            --background: #1e1e2f;
            --card-bg: #2d2d44;
            --text-light: #f1f1f1;
            --recommended: #00cec9;
            --marker: #ff3b30;
            --warning: #ff9f0a;
            --success: #34c759;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text-light);
            padding: 1rem;
            line-height: 1.6;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            /* Cards = 2 partes, Observações = 1 parte */
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .results-grid .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }


        .results-grid .observations {
            flex: 1 1 300px;
            min-width: 280px;
            background: #333851;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            max-height: fit-content;
        }


        header {
            text-align: center;
            margin-bottom: 1.5rem;
            position: relative;
            padding: 0.5rem;
        }

        header h1 {
            color: var(--primary);
            margin: 0;
            font-size: 1.8rem;
        }

        .language-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }

        #languageSelector {
            min-width: 8.5rem;
            width: auto;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--primary);
            background-color: var(--card-bg);
            color: var(--text-light);
        }

        .container {
            max-width: 80%;
            margin: auto;
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 1rem;
            position: relative;
            max-width: 100%;
        }

        .main-wrapper {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            /* Formulário | Cards (maior) | Observações */
            gap: 1.5rem;
            align-items: flex-start;
        }


        .form-section {
            flex: 1 1 300px;
            max-width: 400px;
        }

        .form-section input,
        .form-section select {
            width: 100%;
            font-size: 0.95rem;
            padding: 0.5rem;
        }

        .results-section {
            flex: 2 1 500px;
        }


        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        input,
        select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #555;
            font-size: 1rem;
            background-color: #26263c;
            color: var(--text-light);
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 204, 255, 0.3);
        }

        input:invalid {
            border-color: var(--marker);
        }

        .error-message {
            color: var(--marker);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            cursor: pointer;
            background: var(--secondary);
            color: white;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
        }

        button:hover {
            background: #5649c0;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
            min-height: 130px;
        }

        .cards-section .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .card {
            background: #26263c;
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .card p {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .observation-card {
            background: #2f324a;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transition: transform 0.2s;
        }

        .observations-section {
            background: #333851;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .observation-card:hover {
            transform: translateY(-3px);
        }

        .observation-card h4 {
            color: var(--primary);
            margin: 0;
            font-size: 1.1rem;
            border-bottom: 1px solid #444;
            padding-bottom: 0.3rem;
        }

        .observation-card .status,
        .observation-card .tip {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .observation-card .status .observation-icon {
            font-size: 1.2rem;
        }

        .observation-card .tip .observation-icon {
            font-size: 1rem;
            color: var(--primary);
        }

        .observation-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .observation-wrapper .observation-card {
            flex: 1 1 300px;
            /* ocupa pelo menos 300px, mas cresce */
        }


        .ruler {
            margin: 2rem 0;
        }

        .ruler h3 {
            margin-bottom: 0.5rem;
        }

        .ruler-bar {
            position: relative;
            background: #444;
            height: 1.25rem;
            border-radius: 0.625rem;
            overflow: hidden;
            border: 1px solid #555;
        }

        .ruler-fill {
            position: absolute;
            top: 0;
            height: 100%;
            background: var(--recommended);
            opacity: 0.9;
        }

        .marker {
            position: absolute;
            top: 50%;
            width: 1rem;
            height: 1rem;
            background: var(--marker);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid white;
            z-index: 2;
        }

        .ruler-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #aaa;
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-icon {
            cursor: pointer;
            margin-left: 0.25rem;
            color: var(--primary);
            border: 1px solid;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }

        .tooltip-text {
            visibility: hidden;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            width: 200px;
            z-index: 1;
            font-size: 0.875rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip-container:hover .tooltip-text,
        .tooltip-container:focus .tooltip-text,
        .tooltip-container:focus-within .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .observations {
            background: #333851;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            /* nova sombra */
            border: 1px solid rgba(255, 255, 255, 0.05);
            /* borda leve */
        }


        .observations h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .observations p {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .observation-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .observation-icon {
            font-size: 1rem;
        }

        .success-color {
            color: var(--success);
        }

        .warning-color {
            color: var(--warning);
        }

        .error-color {
            color: var(--marker);
        }

        .buttons {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .info-section {
            margin-top: 2rem;
            background: #333851;
            padding: 1rem;
            border-radius: 0.75rem;
            font-size: 0.9rem;
            line-height: 1.5;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            color: var(--text-light);
        }

        .info-section h3 {
            margin-top: 0;
            color: var(--primary);
        }

        .info-section ul {
            padding-left: 1.2rem;
        }

        .info-section li {
            margin-bottom: 0.5rem;
        }


        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .cards {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }

            .buttons {
                flex-direction: column;
            }

            button {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 0.75rem;
            }

            .card h3 {
                font-size: 1rem;
            }

            .card p {
                font-size: 1.1rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1 id="title">Cable Extrusion Pro: Calculadora DDR/DRB & Insights Técnicos</h1>
        </header>

        <div class="language-container">
            <select id="languageSelector" aria-label="Selecionar idioma">
                <option value="pt">🇧🇷 Português</option>
                <option value="en">🇺🇸 English</option>
            </select>
        </div>

        <div class="main-wrapper">
            <!-- Coluna 1: Formulário -->
            <div class="form-section">
                <div class="form-group">
                    <label id="matrixLabel" for="matrixType">
                        Tipo da Matriz
                        <span class="tooltip-container" tabindex="0">
                            <span class="tooltip-icon" aria-hidden="true">?</span>
                            <span class="tooltip-text" id="matrixTooltip">
                                Parte externa do cabeçote que define a espessura final.
                            </span>
                        </span>
                    </label>
                    <select id="matrixType">
                        <option value="tubular">Tubular</option>
                        <option value="semi">Semi-pressão</option>
                        <option value="pressao">Pressão</option>
                    </select>
                </div>

                <div class="form-group">
                    <label id="toolLabel" for="toolType">
                        Tipo da Guia
                        <span class="tooltip-container" tabindex="0">
                            <span class="tooltip-icon" aria-hidden="true">?</span>
                            <span class="tooltip-text" id="toolTooltip">
                                Mandril (ou Tip) que centraliza o núcleo e define a zona de extrusão.
                            </span>
                        </span>
                    </label>
                    <select id="toolType">
                        <option value="tubular">Tubular</option>
                        <option value="semi">Semi-pressão</option>
                        <option value="pressao">Pressão</option>
                    </select>
                </div>

                <div class="form-group">
                    <label id="materialLabel" for="materialType">Tipo de Material</label>
                    <select id="materialType">
                        <option value="PVC">PVC</option>
                        <option value="LSZH">LSZH</option>
                        <option value="HDPE">HDPE</option>
                        <option value="PBT">PBT</option>
                    </select>
                </div>

                <div class="form-group">
                    <label id="cableLabel" for="cableDiameter">Diâmetro Final do Cabo (mm)</label>
                    <input type="number" id="cableDiameter" min="0.1" step="0.1" required>
                    <span class="error-message" id="cableDiameterError">Por favor, insira um valor válido maior que
                        zero.</span>
                </div>

                <div class="form-group">
                    <label id="matrixDiameterLabel" for="matrixDiameter">Diâmetro Interno da Matriz (mm)</label>
                    <input type="number" id="matrixDiameter" min="0.1" step="0.1" required>
                    <span class="error-message" id="matrixDiameterError">Por favor, insira um valor válido maior que
                        zero.</span>
                </div>

                <div class="form-group">
                    <label id="guideOuterLabel" for="guideOuterDiameter">Diâmetro Externo da Guia (mm)</label>
                    <input type="number" id="guideOuterDiameter" min="0.1" step="0.1" required>
                    <span class="error-message" id="guideOuterDiameterError">Por favor, insira um valor válido maior que
                        zero.</span>
                </div>

                <div class="buttons">
                    <button id="calculateBtn">Calcular</button>
                    <button id="resetBtn">Reiniciar</button>
                    <button id="saveBtn">Salvar Configuração</button>
                </div>
            </div>

            <!-- Coluna 2: Cards -->
            <div class="cards-section">
                <div class="cards">
                    <div class="card">
                        <h3 id="areaMatrixLabel">Área da Matriz</h3>
                        <p id="matrixArea">--</p>
                    </div>
                    <div class="card">
                        <h3 id="areaFlowLabel">Área de Fluxo</h3>
                        <p id="flowArea">--</p>
                    </div>
                    <div class="card">
                        <h3 id="areaCableLabel">Área Final do Cabo</h3>
                        <p id="cableArea">--</p>
                    </div>
                    <div class="card">
                        <h3>DDR</h3>
                        <p id="ddrValue">--</p>
                    </div>
                    <div class="card">
                        <h3>DRB</h3>
                        <p id="drbValue">--</p>
                    </div>
                </div>
            </div>

            <!-- Coluna 3: Observações -->
            <div class="observations-section">
                <h3 id="obsTitle">Observações Inteligentes</h3>
                <div id="observations">--</div>
            </div>
        </div>

        <!-- Réguas abaixo das 3 colunas -->
        <div class="ruler">
            <h3>DDR</h3>
            <div class="ruler-bar" id="ddrRuler">
                <div class="ruler-fill" id="ddrFill"></div>
                <div class="marker" id="ddrMarker"></div>
            </div>
            <div class="ruler-labels" id="ddrLabels">
                <span>0.0</span>
                <span>0.5</span>
                <span>1.0</span>
                <span>1.5</span>
                <span>2.0</span>
            </div>
        </div>

        <div class="ruler">
            <h3>DRB</h3>
            <div class="ruler-bar" id="drbRuler">
                <div class="ruler-fill" id="drbFill"></div>
                <div class="marker" id="drbMarker"></div>
            </div>
            <div class="ruler-labels" id="drbLabels">
                <span>0.0</span>
                <span>0.5</span>
                <span>1.0</span>
                <span>1.5</span>
                <span>2.0</span>
            </div>
        </div>
    </div>




    <script>
        /**
         * Traduções para os diferentes idiomas suportados
         */
        const translations = {
            pt: {
                title: "Cable Extrusion Pro: Calculadora DDR/DRB & Insights Técnicos",
                matrixLabel: "Tipo da Matriz",
                matrixTooltip: "Parte externa do cabeçote que define a espessura final.",
                toolLabel: "Tipo da Guia",
                toolTooltip: "Mandril (ou Tip) que centraliza o núcleo e define a zona de extrusão.",
                materialLabel: "Tipo de Material",
                cableLabel: "Diâmetro Final do Cabo (mm)",
                matrixDiameterLabel: "Diâmetro Interno da Matriz (mm)",
                guideOuterLabel: "Diâmetro Externo da Guia (mm)",
                calculateBtn: "Calcular",
                resetBtn: "Reiniciar",
                saveBtn: "Salvar Configuração",
                areaMatrixLabel: "Área da Matriz",
                areaFlowLabel: "Área de Fluxo",
                areaCableLabel: "Área Final do Cabo",
                obsTitle: "Observações Inteligentes",
                options: ["Tubular", "Semi-pressão", "Pressão"],
                errorMsg: "Por favor, insira um valor válido maior que zero.",
                ddrLow: "DDR baixo: risco de rugas.",
                ddrHigh: "DDR alto: risco de tensão excessiva.",
                ddrOk: "DDR dentro da faixa ideal.",
                drbLow: "DRB baixo: fluxo insuficiente.",
                drbHigh: "DRB alto: possível formação de bolhas.",
                drbOk: "DRB dentro da faixa ideal.",
                configSaved: "Configuração salva com sucesso!",
                configLoaded: "Configuração carregada!",
                validateError: "Por favor, corrija os erros antes de calcular.",
                // Novas dicas detalhadas
                ddrLowTip: "Possível risco de rugas na superfície da capa e acúmulo de material na saída. Recomenda-se aumentar levemente o diâmetro da matriz ou reduzir o diâmetro do cabo.",
                ddrHighTip: "Risco de tensão excessiva no material, podendo gerar defeitos como afinamento excessivo ou quebras. Verifique se a combinação está dentro das especificações do material.",
                ddrOkTip: "Relação adequada para estabilidade dimensional e bom acabamento superficial.",
                drbLowTip: "Fluxo insuficiente entre matriz e guia; pode dificultar a extrusão contínua. Ajuste necessário para evitar pontos de estrangulamento.",
                drbHighTip: "Excesso de espaço de fluxo pode gerar bolhas ou instabilidade no derretimento, além de afetar a pressão interna do cabeçote.",
                drbOkTip: "Fluxo equilibrado entre matriz e guia, garantindo estabilidade durante a extrusão."
            },
            en: {
                title: "Cable Extrusion Pro: DDR/DRB Calculator & Process Insights",
                matrixLabel: "Die Type",
                matrixTooltip: "External part of the head that defines the final thickness.",
                toolLabel: "Tip Type",
                toolTooltip: "Mandrel (or Tip) that centers the core and defines the extrusion zone.",
                materialLabel: "Material Type",
                cableLabel: "Final Cable Diameter (mm)",
                matrixDiameterLabel: "Die Inner Diameter (mm)",
                guideOuterLabel: "Tip Outer Diameter (mm)",
                calculateBtn: "Calculate",
                resetBtn: "Reset",
                saveBtn: "Save Configuration",
                areaMatrixLabel: "Die Area",
                areaFlowLabel: "Flow Area",
                areaCableLabel: "Final Cable Area",
                obsTitle: "Smart Observations",
                options: ["Tubular", "Semi-pressure", "Pressure"],
                errorMsg: "Please enter a valid value greater than zero.",
                ddrLow: "Low DDR: risk of wrinkles.",
                ddrHigh: "High DDR: risk of high tension.",
                ddrOk: "DDR within ideal range.",
                drbLow: "Low DRB: insufficient flow.",
                drbHigh: "High DRB: possible bubbles.",
                drbOk: "DRB within ideal range.",
                configSaved: "Configuration saved successfully!",
                configLoaded: "Configuration loaded!",
                validateError: "Please correct the errors before calculating.",
                // New detailed tips
                ddrLowTip: "Potential risk of wrinkles on the sheath surface and material buildup at the exit. It is recommended to slightly increase the die diameter or reduce the cable diameter.",
                ddrHighTip: "Risk of excessive tension in the material, possibly causing thinning or breaks. Check if the combination is within the material specifications.",
                ddrOkTip: "Adequate ratio for dimensional stability and smooth surface finish.",
                drbLowTip: "Insufficient flow between die and tip; may hinder continuous extrusion. Adjustment needed to avoid choking points.",
                drbHighTip: "Excessive flow space may cause bubbles or melting instability and affect the internal head pressure.",
                drbOkTip: "Balanced flow between die and tip, ensuring stability during extrusion."
            }
        };


        // Estado atual da aplicação
        let state = {
            lang: "pt",
            lastCalculated: null
        };

        /**
         * Carrega as preferências salvas do usuário
         */
        function loadPreferences() {
            try {
                const savedState = localStorage.getItem('ddrCalculatorState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);

                    // Atualiza o idioma primeiro
                    if (parsedState.lang) {
                        state.lang = parsedState.lang;
                        document.getElementById("languageSelector").value = state.lang;
                        switchLanguage();
                    }

                    // Preenche os campos do formulário
                    if (parsedState.formData) {
                        const formData = parsedState.formData;

                        if (formData.matrixType) {
                            document.getElementById("matrixType").value = formData.matrixType;
                        }

                        if (formData.toolType) {
                            document.getElementById("toolType").value = formData.toolType;
                        }

                        if (formData.materialType) {
                            document.getElementById("materialType").value = formData.materialType;
                        }

                        if (formData.cableDiameter) {
                            document.getElementById("cableDiameter").value = formData.cableDiameter;
                        }

                        if (formData.matrixDiameter) {
                            document.getElementById("matrixDiameter").value = formData.matrixDiameter;
                        }

                        if (formData.guideOuterDiameter) {
                            document.getElementById("guideOuterDiameter").value = formData.guideOuterDiameter;
                        }

                        // Se todos os campos numéricos têm valores, recalcula
                        if (formData.cableDiameter && formData.matrixDiameter && formData.guideOuterDiameter) {
                            calculateValues();
                        }
                    }

                    showTemporaryMessage(translations[state.lang].configLoaded);
                }
            } catch (error) {
                console.error("Erro ao carregar preferências:", error);
            }
        }

        /**
         * Salva as preferências do usuário
         */
        function savePreferences() {
            try {
                const formData = {
                    matrixType: document.getElementById("matrixType").value,
                    toolType: document.getElementById("toolType").value,
                    materialType: document.getElementById("materialType").value,
                    cableDiameter: document.getElementById("cableDiameter").value,
                    matrixDiameter: document.getElementById("matrixDiameter").value,
                    guideOuterDiameter: document.getElementById("guideOuterDiameter").value
                };

                const stateToSave = {
                    lang: state.lang,
                    formData: formData
                };

                localStorage.setItem('ddrCalculatorState', JSON.stringify(stateToSave));
                showTemporaryMessage(translations[state.lang].configSaved);
            } catch (error) {
                console.error("Erro ao salvar preferências:", error);
            }
        }

        /**
         * Mostra uma mensagem temporária ao usuário
         * @param {string} message - Mensagem a ser exibida
         */
        function showTemporaryMessage(message) {
            const observations = document.getElementById("observations");
            const originalContent = observations.innerHTML;

            observations.innerHTML = `<div class="observation-item"><span class="observation-icon success-color">✓</span> ${message}</div>`;

            setTimeout(() => {
                observations.innerHTML = originalContent;
            }, 2000);
        }

        /**
         * Muda o idioma da interface
         */
        function switchLanguage() {
            state.lang = document.getElementById("languageSelector").value;
            const t = translations[state.lang];

            // Atualiza textos da interface
            document.getElementById("title").innerText = t.title;
            document.getElementById("matrixLabel").childNodes[0].textContent = t.matrixLabel + " ";
            document.getElementById("matrixTooltip").innerText = t.matrixTooltip;
            document.getElementById("toolLabel").childNodes[0].textContent = t.toolLabel + " ";
            document.getElementById("toolTooltip").innerText = t.toolTooltip;
            document.getElementById("materialLabel").innerText = t.materialLabel;
            document.getElementById("cableLabel").innerText = t.cableLabel;
            document.getElementById("matrixDiameterLabel").innerText = t.matrixDiameterLabel;
            document.getElementById("guideOuterLabel").innerText = t.guideOuterLabel;
            document.getElementById("calculateBtn").innerText = t.calculateBtn;
            document.getElementById("resetBtn").innerText = t.resetBtn;
            document.getElementById("saveBtn").innerText = t.saveBtn;
            document.getElementById("areaMatrixLabel").innerText = t.areaMatrixLabel;
            document.getElementById("areaFlowLabel").innerText = t.areaFlowLabel;
            document.getElementById("areaCableLabel").innerText = t.areaCableLabel;
            document.getElementById("obsTitle").innerText = t.obsTitle;

            // Atualiza opções dos selects
            const opt = t.options;
            ['matrixType', 'toolType'].forEach(id => {
                const select = document.getElementById(id);
                select.options[0].text = opt[0];
                select.options[1].text = opt[1];
                select.options[2].text = opt[2];
            });

            // Atualiza mensagens de erro
            document.getElementById("cableDiameterError").innerText = t.errorMsg;
            document.getElementById("matrixDiameterError").innerText = t.errorMsg;
            document.getElementById("guideOuterDiameterError").innerText = t.errorMsg;

            // Se houver um cálculo recente, atualiza as observações
            if (state.lastCalculated) {
                updateObservations(
                    state.lastCalculated.ddr,
                    state.lastCalculated.drb,
                    state.lastCalculated.material
                );
            }
        }

        /**
         * Valida os valores de entrada
         * @returns {boolean} Se todos os valores são válidos
         */
        function validateInputs() {
            const inputs = [
                { id: "cableDiameter", errorId: "cableDiameterError" },
                { id: "matrixDiameter", errorId: "matrixDiameterError" },
                { id: "guideOuterDiameter", errorId: "guideOuterDiameterError" }
            ];

            let isValid = true;

            inputs.forEach(input => {
                const inputElement = document.getElementById(input.id);
                const errorElement = document.getElementById(input.errorId);
                const value = parseFloat(inputElement.value);

                if (isNaN(value) || value <= 0) {
                    inputElement.classList.add("invalid");
                    errorElement.style.display = "block";
                    isValid = false;
                } else {
                    inputElement.classList.remove("invalid");
                    errorElement.style.display = "none";
                }
            });

            // Verificação adicional: a guia deve ser menor que a matriz
            const matrixDiameter = parseFloat(document.getElementById("matrixDiameter").value);
            const guideDiameter = parseFloat(document.getElementById("guideOuterDiameter").value);

            if (!isNaN(matrixDiameter) && !isNaN(guideDiameter) && guideDiameter >= matrixDiameter) {
                document.getElementById("guideOuterDiameter").classList.add("invalid");
                document.getElementById("guideOuterDiameterError").innerText =
                    state.lang === "pt" ?
                        "O diâmetro da guia deve ser menor que o da matriz." :
                        "The guide diameter must be smaller than the matrix diameter.";
                document.getElementById("guideOuterDiameterError").style.display = "block";
                isValid = false;
            }

            return isValid;
        }

        /**
         * Calcula os valores de DDR e DRB
         */
        function calculateValues() {
            if (!validateInputs()) {
                showTemporaryMessage(translations[state.lang].validateError);
                return;
            }

            const dCable = parseFloat(document.getElementById("cableDiameter").value);
            const dMatrix = parseFloat(document.getElementById("matrixDiameter").value);
            const dGuideOuter = parseFloat(document.getElementById("guideOuterDiameter").value);
            const material = document.getElementById("materialType").value;

            // Cálculo das áreas
            const areaCable = Math.PI * Math.pow(dCable / 2, 2);
            const areaMatrix = Math.PI * Math.pow(dMatrix / 2, 2);
            const areaFlow = areaMatrix - Math.PI * Math.pow(dGuideOuter / 2, 2);

            // Cálculo dos índices DDR e DRB
            const ddr = (areaMatrix / areaCable).toFixed(3);
            const drb = (areaMatrix / areaFlow).toFixed(3);

            // Atualiza os resultados na interface
            document.getElementById("matrixArea").innerText = areaMatrix.toFixed(2) + " mm²";
            document.getElementById("flowArea").innerText = areaFlow.toFixed(2) + " mm²";
            document.getElementById("cableArea").innerText = areaCable.toFixed(2) + " mm²";
            document.getElementById("ddrValue").innerText = ddr;
            document.getElementById("drbValue").innerText = drb;

            // Salva o último cálculo no estado
            state.lastCalculated = {
                ddr: ddr,
                drb: drb,
                material: material
            };

            // Atualiza os marcadores visuais nas réguas
            updateRulers(ddr, drb, material);

            // Atualiza as observações baseadas nos valores calculados
            updateObservations(ddr, drb, material);
        }

        /**
         * Atualiza os marcadores visuais nas réguas
         * @param {number} ddr - Valor DDR calculado
         * @param {number} drb - Valor DRB calculado
         * @param {string} material - Material selecionado
         */
        function updateRulers(ddr, drb, material) {
            // Faixas recomendadas para cada material
            const recommendations = {
                PVC: { ddrMin: 1.1, ddrMax: 1.3, drbMin: 0.9, drbMax: 1.1 },
                LSZH: { ddrMin: 1.2, ddrMax: 1.4, drbMin: 0.95, drbMax: 1.2 },
                HDPE: { ddrMin: 1.3, ddrMax: 1.5, drbMin: 1.0, drbMax: 1.3 },
                PBT: { ddrMin: 1.15, ddrMax: 1.35, drbMin: 0.95, drbMax: 1.25 }
            };

            const limits = recommendations[material];

            // Escala máxima dinâmica para as réguas
            const ddrScale = Math.max(2.0, parseFloat(ddr) * 1.2);
            const drbScale = Math.max(2.0, parseFloat(drb) * 1.2);

            // Atualiza os marcadores
            updateRuler("ddrRuler", "ddrFill", "ddrMarker", "ddrLabels", ddr, limits.ddrMin, limits.ddrMax, ddrScale);
            updateRuler("drbRuler", "drbFill", "drbMarker", "drbLabels", drb, limits.drbMin, limits.drbMax, drbScale);
        }

        /**
         * Atualiza uma régua específica
         * @param {string} rulerId - ID do elemento da régua
         * @param {string} fillId - ID do elemento de preenchimento
         * @param {string} markerId - ID do elemento marcador
         * @param {string} labelsId - ID do elemento de rótulos
         * @param {number} value - Valor a ser marcado
         * @param {number} min - Valor mínimo recomendado
         * @param {number} max - Valor máximo recomendado
         * @param {number} scale - Escala máxima da régua
         */
        function updateRuler(rulerId, fillId, markerId, labelsId, value, min, max, scale) {
            const ruler = document.getElementById(rulerId);
            const fill = document.getElementById(fillId);
            const marker = document.getElementById(markerId);
            const labels = document.getElementById(labelsId);

            const rulerWidth = ruler.clientWidth;

            // Ajusta a posição da zona recomendada
            const minPos = (min / scale) * rulerWidth;
            const maxPos = (max / scale) * rulerWidth;

            fill.style.left = minPos + "px";
            fill.style.width = (maxPos - minPos) + "px";

            // Posiciona o marcador atual
            let markerPos = (value / scale) * rulerWidth;
            markerPos = Math.max(0, Math.min(rulerWidth, markerPos));
            marker.style.left = markerPos + "px";

            // Atualiza os rótulos da escala
            updateRulerLabels(labels, scale);
        }

        /**
         * Atualiza os rótulos da escala de uma régua
         * @param {HTMLElement} labelsElement - Elemento DOM com os rótulos
         * @param {number} scale - Escala máxima da régua
         */
        function updateRulerLabels(labelsElement, scale) {
            // Cria pontos intermediários para a escala
            const divisions = 5;
            labelsElement.innerHTML = '';

            for (let i = 0; i < divisions; i++) {
                const value = (scale * i / (divisions - 1)).toFixed(1);
                const span = document.createElement('span');
                span.innerText = value;
                labelsElement.appendChild(span);
            }
        }

        /**
         * Atualiza as observações baseadas nos valores calculados
         * @param {number} ddr - Valor DDR calculado
         * @param {number} drb - Valor DRB calculado
         * @param {string} material - Material selecionado
         */
        function updateObservations(ddr, drb, material) {
            const t = translations[state.lang];
            const observationsDiv = document.getElementById("observations");

            const recommendations = {
                PVC: { ddrMin: 1.1, ddrMax: 1.3, drbMin: 0.9, drbMax: 1.1 },
                LSZH: { ddrMin: 1.2, ddrMax: 1.4, drbMin: 0.95, drbMax: 1.2 },
                HDPE: { ddrMin: 1.3, ddrMax: 1.5, drbMin: 1.0, drbMax: 1.3 },
                PBT: { ddrMin: 1.15, ddrMax: 1.35, drbMin: 0.95, drbMax: 1.25 }
            };

            const limits = recommendations[material];

            // Mensagens para DDR
            let ddrStatusMsg, ddrTipMsg, ddrIcon, ddrClass;
            if (parseFloat(ddr) < limits.ddrMin) {
                ddrStatusMsg = t.ddrLow;
                ddrTipMsg = t.ddrLowTip;
                ddrIcon = "⚠️";
                ddrClass = "warning-color";
            } else if (parseFloat(ddr) > limits.ddrMax) {
                ddrStatusMsg = t.ddrHigh;
                ddrTipMsg = t.ddrHighTip;
                ddrIcon = "❌";
                ddrClass = "error-color";
            } else {
                ddrStatusMsg = t.ddrOk;
                ddrTipMsg = t.ddrOkTip;
                ddrIcon = "✓";
                ddrClass = "success-color";
            }



            // Mensagens para DRB
            let drbStatusMsg, drbTipMsg, drbIcon, drbClass;
            if (parseFloat(drb) < limits.drbMin) {
                drbStatusMsg = t.drbLow;
                drbTipMsg = t.drbLowTip;
                drbIcon = "⚠️";
                drbClass = "warning-color";
            } else if (parseFloat(drb) > limits.drbMax) {
                drbStatusMsg = t.drbHigh;
                drbTipMsg = t.drbHighTip;
                drbIcon = "❌";
                drbClass = "error-color";
            } else {
                drbStatusMsg = t.drbOk;
                drbTipMsg = t.drbOkTip;
                drbIcon = "✓";
                drbClass = "success-color";
            }



            // Atualiza as observações na interface
            observationsDiv.innerHTML = `
    <div class="observation-wrapper">
        <div class="observation-card">
            <h4>DDR (${material}: ${limits.ddrMin.toFixed(2)} ~ ${limits.ddrMax.toFixed(2)})</h4>
            <div class="status">
                <span class="observation-icon ${ddrClass}">${ddrIcon}</span>
                <span>${ddrStatusMsg}</span>
            </div>
            <div class="tip">
                <span class="observation-icon">💡</span>
                <span>${ddrTipMsg}</span>
            </div>
        </div>

        <div class="observation-card">
            <h4>DRB (${material}: ${limits.drbMin.toFixed(2)} ~ ${limits.drbMax.toFixed(2)})</h4>
            <div class="status">
                <span class="observation-icon ${drbClass}">${drbIcon}</span>
                <span>${drbStatusMsg}</span>
            </div>
            <div class="tip">
                <span class="observation-icon">💡</span>
                <span>${drbTipMsg}</span>
            </div>
        </div>
    </div>
`;


        }

        /**
         * Reinicia o formulário
         */
        function resetForm() {
            // Limpa os campos de entrada
            const inputs = ["cableDiameter", "matrixDiameter", "guideOuterDiameter"];
            inputs.forEach(id => {
                const input = document.getElementById(id);
                input.value = "";
                input.classList.remove("invalid");

                // Esconde mensagens de erro
                const errorId = id + "Error";
                document.getElementById(errorId).style.display = "none";
            });

            // Reinicia os valores exibidos
            const resultFields = ["matrixArea", "flowArea", "cableArea", "ddrValue", "drbValue"];
            resultFields.forEach(id => {
                document.getElementById(id).innerText = "--";
            });

            // Limpa observações
            document.getElementById("observations").innerHTML = "--";

            // Reinicia os marcadores visuais
            ["ddrFill", "drbFill"].forEach(id => {
                document.getElementById(id).style.width = "0";
                document.getElementById(id).style.left = "0";
            });

            ["ddrMarker", "drbMarker"].forEach(id => {
                document.getElementById(id).style.left = "0";
            });

            // Limpa o último cálculo
            state.lastCalculated = null;
        }

        // Inicialização da aplicação
        document.addEventListener("DOMContentLoaded", function () {
            // Registra eventos
            document.getElementById("languageSelector").addEventListener("change", switchLanguage);
            document.getElementById("calculateBtn").addEventListener("click", calculateValues);
            document.getElementById("resetBtn").addEventListener("click", resetForm);
            document.getElementById("saveBtn").addEventListener("click", savePreferences);

            // Campos numéricos: atualizar ao mudar valores (opcional)
            ["cableDiameter", "matrixDiameter", "guideOuterDiameter"].forEach(id => {
                document.getElementById(id).addEventListener("input", function () {
                    // Remove mensagens de erro quando o usuário começa a corrigir
                    document.getElementById(id + "Error").style.display = "none";
                    document.getElementById(id).classList.remove("invalid");
                });
            });

            // Carrega preferências salvas
            loadPreferences();

            // Configura os tooltips para acessibilidade
            setupTooltipAccessibility();
        });

        /**
         * Configura a acessibilidade para os tooltips
         */
        function setupTooltipAccessibility() {
            const tooltipContainers = document.querySelectorAll('.tooltip-container');

            tooltipContainers.forEach(container => {
                container.setAttribute('tabindex', '0');
                container.setAttribute('role', 'button');
                container.setAttribute('aria-label', container.querySelector('.tooltip-text').textContent);

                // Suporte para teclado
                container.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        const tooltipText = this.querySelector('.tooltip-text');
                        const isVisible = tooltipText.style.visibility === 'visible';

                        tooltipText.style.visibility = isVisible ? 'hidden' : 'visible';
                        tooltipText.style.opacity = isVisible ? '0' : '1';
                    }
                });
            });
        }
    </script>
</body>

</html>